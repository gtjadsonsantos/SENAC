SET SQL_SAFE_UPDATES = 0;
DROP DATABASE IF EXISTS DBCONDOMINIO;
CREATE DATABASE DBCONDOMINIO;
USE DBCONDOMINIO;

CREATE TABLE CONDOMINIO (
	IDCONDOMINIO INT NOT NULL AUTO_INCREMENT 
    , NOME VARCHAR(100)
    , PRIMARY KEY (IDCONDOMINIO)
);

CREATE TABLE BLOCO (
	IDBLOCO INT NOT NULL AUTO_INCREMENT
    , IDCONDOMINIO INT NOT NULL
    , NOME VARCHAR(25)
    , PRIMARY KEY (IDBLOCO)
    , FOREIGN KEY (IDCONDOMINIO) REFERENCES CONDOMINIO (IDCONDOMINIO)
);

CREATE TABLE PESSOA (
	IDPESSOA INT NOT NULL AUTO_INCREMENT
    , NOME VARCHAR(100)
    , SEXO CHAR(1)
    , DT_NASCIMENTO DATE
    , IDADE INT
    , PRIMARY KEY (IDPESSOA)
);

CREATE TABLE APARTAMENTO (
	IDAPARTAMENTO INT NOT NULL AUTO_INCREMENT
	, IDBLOCO INT NOT NULL
    , IDPESSOA INT 
    , NUMERO INT
    , ANDAR INT
    , TAMANHO FLOAT
    , PRIMARY KEY (IDAPARTAMENTO)
    , FOREIGN KEY (IDBLOCO) REFERENCES BLOCO (IDBLOCO)
    , FOREIGN KEY (IDPESSOA) REFERENCES PESSOA (IDPESSOA)
);

CREATE TABLE MORADOR (
	IDPESSOA INT NOT NULL
    , IDAPARTAMENTO INT NOT NULL
    , PRIMARY KEY (IDPESSOA, IDAPARTAMENTO)
    , FOREIGN KEY (IDPESSOA) REFERENCES PESSOA (IDPESSOA)
    , FOREIGN KEY (IDAPARTAMENTO) REFERENCES APARTAMENTO (IDAPARTAMENTO)
);

CREATE TABLE VISITANTE (
	IDVISITANTE INT NOT NULL AUTO_INCREMENT
    , IDPESSOA INT NOT NULL
    , IDAPARTAMENTO INT NOT NULL
    , DTVISITA DATE
    , PRIMARY KEY (IDVISITANTE)
    , FOREIGN KEY (IDPESSOA) REFERENCES PESSOA (IDPESSOA)
    , FOREIGN KEY (IDAPARTAMENTO) REFERENCES APARTAMENTO (IDAPARTAMENTO)
);


## INSERT CONDOMINIO 

INSERT INTO CONDOMINIO VALUES(1,"MARAVILHA");

## INSERT BLOCO

INSERT INTO BLOCO VALUES(1,1,"A");
INSERT INTO BLOCO VALUES(2,1,"B");


## INSERT PESSOA

INSERT INTO PESSOA VALUES(1,"JADSON","M","1997-12-21",22);
INSERT INTO PESSOA VALUES(2,"BRUNA","F","1994-01-18",26);
INSERT INTO PESSOA VALUES(3,"CASSIA","M","1978-03-7",34);


## INSERTS APARTAMENTO

INSERT INTO APARTAMENTO VALUES(1,1,1,101,1,15.5);
INSERT INTO APARTAMENTO VALUES(2,1,2,101,1,15.5);

## INSERT MORADOR 

INSERT INTO MORADOR VALUES(1,1);
INSERT INTO MORADOR VALUES(2,1);
INSERT INTO MORADOR VALUES(3,1);



## INSERT VISITANTE

INSERT INTO VISITANTE VALUES(1,1,1,NOW());
INSERT INTO VISITANTE VALUES(2,2,1,NOW());
INSERT INTO VISITANTE VALUES(3,2,1,NOW());
INSERT INTO VISITANTE VALUES(4,2,1,NOW());
INSERT INTO VISITANTE VALUES(5,1,2,NOW());
INSERT INTO VISITANTE VALUES(6,2,2,NOW());
INSERT INTO VISITANTE VALUES(7,2,2,NOW());
INSERT INTO VISITANTE VALUES(8,2,2,NOW());


# QUESTAO 1 - CRIE UMA CONSULTA SQL QUE LISTE O TAMANHO MÉDIO DOS
#APARTAMENTOS POR CONDOMÍNIO. LISTE O CÓDIGO IDENTIDICADOR DO CONDOMÍNIO,
#NOME DO CONDOMÍNIO E A QUANTIDADE DE APARTAMENTOS, A MÉDIA DO TAMANHO DOS
#APARTAMENTOS E A QUANTIDADE MÉDIA DE MORADORES

SELECT 
AVG(APARTAMENTO.TAMANHO) AS TAMANHO_MEDIO_AP,
COUNT(APARTAMENTO.IDAPARTAMENTO) AS QUANTIDADE_AP,
AVG(MORADOR.IDPESSOA) AS MEDIA_MORADOR,
CONDOMINIO.IDCONDOMINIO,
CONDOMINIO.NOME
FROM CONDOMINIO
    INNER JOIN BLOCO ON
    CONDOMINIO.IDCONDOMINIO = BLOCO.IDCONDOMINIO
    INNER JOIN APARTAMENTO ON 
    APARTAMENTO.IDBLOCO = BLOCO.IDBLOCO
    INNER JOIN MORADOR ON 
    MORADOR.IDAPARTAMENTO = APARTAMENTO.IDAPARTAMENTO
GROUP BY 
    CONDOMINIO.IDCONDOMINIO,
    CONDOMINIO.NOME;

# QUESTAO 2 - CRIE UMA CONSULTA SQL QUE LISTE A QUANTIDADE DE MORADORES, MÉDIA
#DA IDADE AGRUPADOR POR SEXO E POR CONDOMÍNIO. LISTE O CÓDIGO IDENTIDICADOR
#DO CONDOMÍNIO, NOME DO CONDOMÍNIO, QUANTIDADE DE MORADORES E A MÉDIA DA
#IDADE

SELECT
COUNT(MORADOR.IDPESSOA) AS QUANTIDADE_MORADORES ,
AVG(PESSOA.IDADE)  AS MEDIA_IDADE,
CONDOMINIO.NOME AS CONDOMINIO,
PESSOA.SEXO
FROM CONDOMINIO 
    INNER JOIN BLOCO ON 
    BLOCO.IDCONDOMINIO = CONDOMINIO.IDCONDOMINIO
    INNER JOIN APARTAMENTO ON 
    APARTAMENTO.IDBLOCO = BLOCO.IDBLOCO
    INNER JOIN MORADOR ON 
    MORADOR.IDAPARTAMENTO = APARTAMENTO.IDAPARTAMENTO
    INNER JOIN PESSOA ON
    PESSOA.IDPESSOA = MORADOR.IDPESSOA
GROUP BY 
    PESSOA.SEXO,
    CONDOMINIO.NOME


# QUESTAO 3 - CRIE UMA CONSULTA SQL QUE LISTE A QUANTIDADE DE PROPRIETÁRIOS
#AGRUPADO POR SEXO. PARA IDENTIFICAR O PROPRIETÁRIO UTILIZE O CAMPO IDPESSOA
#DA TABELA DE APARTAMENTO
    

SELECT 
COUNT(MORADOR.IDPESSOA) AS QUANTIDADE_PROPRIETARIOS,
PESSOA.SEXO
FROM MORADOR 
    INNER JOIN PESSOA ON 
    MORADOR.IDPESSOA = PESSOA.IDPESSOA
    INNER JOIN APARTAMENTO ON
    APARTAMENTO.IDAPARTAMENTO = MORADOR.IDAPARTAMENTO
WHERE 
    APARTAMENTO.IDPESSOA = 1
GROUP BY 
    PESSOA.SEXO


#QUESTAO 4 - CRIE UMA CONSULTA SQL QUE LISTE A QUANTIDADE DE VISITA POR
#CONDOMÍNIO ORDENADO PELA MAIOR QUANTIDADE. LISTE O CÓDIGO IDENTIDICADOR DO
#CONDOMÍNIO, NOME DO CONDOMÍNIO E A QUANTIDADE DE VISITAS, ORDENANDO PELA
#QUANTIDATE DE VISITA

SELECT
CONDOMINIO.NOME,
CONDOMINIO.IDCONDOMINIO,
COUNT(VISITANTE.IDVISITANTE) AS VISITA_MAX
FROM CONDOMINIO
    INNER JOIN BLOCO ON 
    BLOCO.IDCONDOMINIO = CONDOMINIO.IDCONDOMINIO
    INNER JOIN APARTAMENTO ON 
    APARTAMENTO.IDBLOCO = BLOCO.IDBLOCO
    INNER JOIN VISITANTE ON 
    VISITANTE.IDAPARTAMENTO = APARTAMENTO.IDAPARTAMENTO
GROUP BY
    CONDOMINIO.NOME,
    CONDOMINIO.IDCONDOMINIO
ORDER BY 
    MAX(VISITANTE.IDVISITANTE)